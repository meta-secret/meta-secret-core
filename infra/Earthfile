VERSION 0.8
FROM scratch

taskomatic-build:
    FROM python:3.11-slim-bookworm

    RUN apt update && apt install -y build-essential curl wget
    RUN wget -q -O - https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

    COPY k3d /tasko/k3d
    WORKDIR /tasko/k3d
    RUN pip install -r requirements.txt
    RUN invoke --list
    SAVE IMAGE localhost/taskomatic:latest

taskomatic-run:
    LOCALLY
    WITH DOCKER --load=+taskomatic-build
        RUN docker run -ti --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            --name taskomatic \
            localhost/taskomatic:latest ???
    END


kcl-config-gen:
    FROM --platform=linux/amd64 kcllang/kcl:v0.11.0
    RUN --no-cache kcl

build-sops:
    FROM quay.io/getsops/sops:v3.9.4
    RUN apt update && apt install -y build-essential age curl tar

    #Install age
    ENV AGE_VERSION=v1.2.1
    ENV AGE_ARCHIVE=age-${AGE_VERSION}-linux-amd64.tar.gz
    ENV AGE_RELEASES_PAGE=https://github.com/FiloSottile/age/releases
    RUN curl -LO ${AGE_RELEASES_PAGE}/download/${AGE_VERSION}/${AGE_ARCHIVE} && \
        tar -xzf ${AGE_ARCHIVE} && \
        mv age/age age/age-keygen /usr/local/bin/ && \
        rm -rf age ${AGE_ARCHIVE}

    RUN --no-cache age --version